name: Build and push to Cachix

on:

  push:
    branches:
      - main

  workflow_dispatch: { }

jobs:

  cache:

    runs-on: ubuntu-latest
    steps:

    # Checkout the repository contents.
    - uses: actions/checkout@v3

      # To allow subsequent actions to access the private SSH keys needed during the build process.
    - uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    # Install the Nix Package manager.
    - uses: cachix/install-nix-action@v20
      with:

        nix_path: nixpkgs=channel:nixos-unstable
    
      # Push to Cachix.
    - uses: cachix/cachix-action@v12
      with:

        name: dotnix
        authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        extraPullNames: nix-community

        # Not sure if this is needed, but my mind rests in peace knowing it's there.
        # Filters the encrypted secrets derivation from going into the public cache.
        pushFilter: "(dotnix-secrets$)"

        # Ensure this is empty for the pushFilter to work as expected.
        # See: https://github.com/cachix/cachix-action/blob/6a2e08b5ebf7a9f285ff57b1870a4262b06e0bee/action.yml#L18
        pathsToPush: ""

      # Build and cache my main NixOS configuration (See 'Internals' section of: https://nixos.wiki/wiki/Nixos-rebuild).
    - run: nix build .#nixosConfigurations.atlas.config.system.build.toplevel -L
